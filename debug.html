<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 5px; }
        .word { border: 1px solid #ccc; margin: 5px 0; padding: 10px; }
        .valid { background: #e8f5e8; }
        .invalid { background: #ffe8e8; }
    </style>
</head>
<body>
    <h1>CSV Parser Debug</h1>
    <button onclick="loadAndParseCSV()">Load CSV</button>
    <div id="stats"></div>
    <div id="results"></div>

    <script>
        async function loadAndParseCSV() {
            try {
                const response = await fetch('./src/data/spelling_bee_words.csv');
                const csvText = await response.text();
                
                console.log('CSV loaded, length:', csvText.length);
                
                const words = parseCSV(csvText);
                displayResults(words);
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('results').innerHTML = '<p>Error: ' + error.message + '</p>';
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const words = [];
            const debug = [];
            
            console.log('Total lines:', lines.length);
            
            // Skip header row if present
            const startIndex = lines[0].toLowerCase().includes('word') ? 1 : 0;
            console.log('Starting from line:', startIndex);
            
            for (let i = startIndex; i < Math.min(lines.length, 20); i++) { // Limit to first 20 for debugging
                const line = lines[i].trim();
                if (line) {
                    console.log(`Line ${i}:`, line);
                    
                    // Handle CSV parsing with potential commas in quoted fields
                    const matches = line.match(/(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g);
                    console.log(`Matches for line ${i}:`, matches);
                    
                    if (matches && matches.length >= 4) {
                        const number = matches[0]?.replace(/^"|"$/g, '').trim();
                        const word = matches[1]?.replace(/^"|"$/g, '').trim();
                        const partOfSpeech = matches[2]?.replace(/^"|"$/g, '').trim();
                        const definition = matches[3]?.replace(/^"|"$/g, '').trim();
                        const alternateSpelling = matches.length > 4 ? matches[4]?.replace(/^"|"$/g, '').trim() : '';
                        
                        const isValid = isValidWord(word);
                        const grade = estimateGrade(word);
                        
                        const parsedWord = {
                            lineNumber: i,
                            number,
                            word,
                            partOfSpeech,
                            definition,
                            alternateSpelling,
                            isValid,
                            grade
                        };
                        
                        debug.push(parsedWord);
                        
                        if (isValid) {
                            words.push({
                                word: word.toLowerCase(),
                                grade: grade,
                                definition: definition || 'A word to spell',
                                partOfSpeech: partOfSpeech || '',
                                alternateSpelling: alternateSpelling || ''
                            });
                        }
                    }
                }
            }
            
            console.log('Valid words found:', words.length);
            console.log('Debug info:', debug);
            
            return { words, debug };
        }
        
        function isValidWord(word) {
            if (!word) return false;
            
            const cleanWord = word.trim().replace(/^"|"$/g, '');
            
            if (!cleanWord) return false;
            if (/^\d+(\.\d+)?$/.test(cleanWord)) return false;
            if (/^\d/.test(cleanWord)) return false;
            
            // Allow spaces in words like "lo mein"
            if (!/^[a-zA-Z][a-zA-Z'\-\s]*$/.test(cleanWord)) return false;
            if (cleanWord.length < 2) return false;
            
            return true;
        }
        
        function estimateGrade(word) {
            const length = word.length;
            if (length <= 3) return 1;
            if (length <= 5) return 2;
            if (length <= 7) return 3;
            if (length <= 9) return 4;
            return 5;
        }
        
        function displayResults(data) {
            const { words, debug } = data;
            
            document.getElementById('stats').innerHTML = `
                <h2>Stats</h2>
                <p>Valid words: ${words.length}</p>
                <p>Total processed: ${debug.length}</p>
            `;
            
            const resultsHTML = debug.map(item => `
                <div class="word ${item.isValid ? 'valid' : 'invalid'}">
                    <strong>Line ${item.lineNumber}:</strong> "${item.word}" 
                    (${item.partOfSpeech}) - Grade ${item.grade} - Valid: ${item.isValid}
                    <br><small>Definition: ${item.definition}</small>
                </div>
            `).join('');
            
            document.getElementById('results').innerHTML = resultsHTML;
        }
    </script>
</body>
</html>